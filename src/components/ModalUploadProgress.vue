<template>
  <Modal
    :is-open="state.isOpen"
    :title="$t('modalUploadProgress.title')"
    hide-decoration
    not-closeable
  >
    <template v-slot:banner>
      <Warning
        :message="
          isElectron
            ? $t('modalUploadProgress.warning.messageElectron')
            : $t('modalUploadProgress.warning.message')
        "
        :title="$t('modalUploadProgress.warning.title')"
      />
    </template>
    <template>
      <div class="modal-upload-progress">
        <div class="upload-text">
          {{
            state.inProgress
              ? $t("modalUploadProgress.inProgress.text")
              : state.wasSuccess
                ? $t("modalUploadProgress.success.text")
                : $t("modalUploadProgress.failure.text")
          }}
        </div>
        <div class="upload-subtext">
          {{
            state.inProgress
              ? $t("modalUploadProgress.inProgress.subText")
              : state.wasSuccess
                ? $t("modalUploadProgress.success.subText")
                : $t("modalUploadProgress.failure.subText")
          }}
        </div>
        <div class="visual-container">
          <MaterialDesignIcon
            v-if="state.inProgress"
            :icon="mdiLoading"
            class="icon"
            height="120"
            slow-spin
            width="120"
          />
          <MaterialDesignIcon
            v-else-if="!state.inProgress && state.wasSuccess"
            :icon="mdiFileCheckOutline"
            class="icon"
            height="120"
            width="120"
          />
          <MaterialDesignIcon
            v-else
            :icon="mdiFileRemoveOutline"
            class="icon"
            height="120"
            width="120"
          />
        </div>

        <div class="progress-text">
          {{ progressString }}
        </div>

        <div
          v-if="!state.inProgress && !state.wasSuccess"
          class="button-container"
        >
          <Button
            :disabled="state.inProgress"
            :label="$t('modalUploadProgress.failure.buttonLabel2')"
            class="cancel-button"
            danger
            outline
            @click="onClickCancel"
          />

          <Button
            :disabled="state.inProgress"
            :label="$t('modalUploadProgress.failure.buttonLabel')"
            class="retry-button"
            @click="onClickRetry"
          />
        </div>
      </div>
    </template>
  </Modal>
</template>

<script lang="ts">
import { computed, createComponent, PropType, SetupContext } from "@vue/composition-api";
import { mdiFileCheckOutline, mdiFileRemoveOutline, mdiLoading } from "@mdi/js";

import Button from "./Button.vue";
import Modal from "./Modal.vue";
import Warning from "./Warning.vue";
import MaterialDesignIcon from "./MaterialDesignIcon.vue";

export interface State {
    isOpen: boolean;
    inProgress: boolean;
    wasSuccess: boolean;
    currentChunk: number;
    totalChunks: number;
}

export default createComponent({
    name: "ModalUploadProgress",
    components: {
        Button,
        Modal,
        Warning,
        MaterialDesignIcon
    },
    model: {
        prop: "state",
        event: "change"
    },
    props: { state: Object as PropType<State> },
    setup(props: { state: State }, context: SetupContext) {
        const buttonLabel = computed<string>(() => context.root
            .$t("modalUploadProgress.failure.buttonLabel")
            .toString());

        const progressString = computed<string>(() => {
            const completionPercentage =
                    props.state.currentChunk <= props.state.totalChunks ?
                        props.state.currentChunk / props.state.totalChunks * 100 :
                        0;

            return `${completionPercentage.toFixed(2)}%`;
        });

        const isElectron = computed(() => false);

        function close(): void {
            context.emit("change", false);
        }

        function onClickRetry(): void {
            // user clicked retry
            context.emit("retry");
        }

        function onClickCancel(): void {
            close();
        }

        return {
            buttonLabel,
            mdiLoading,
            mdiFileCheckOutline,
            mdiFileRemoveOutline,
            progressString,
            isElectron,
            onClickRetry,
            onClickCancel
        };
    }
});
</script>

<style lang="postcss" scoped>
    .modal-upload-progress {
        align-items: center;
        display: flex;
        flex-direction: column;
    }

    .upload-text {
        color: var(--color-ghostlands-coal);
        display: flex;
        font-size: 20px;
        font-weight: 500;
        justify-content: center;
        margin-block-end: 20px;
        text-align: center;
    }

    .progress-text {
        color: var(--color-china-blue);
        font-size: 18px;
        margin-block-start: 60px;
    }

    .upload-subtext {
        color: var(--color-china-blue);
        font-size: 18px;
        margin-block-end: 60px;
    }

    .icon {
        margin-inline-start: 10px;
    }

    .button-container {
        display: flex;
        flex-flow: row nowrap;
        justify-content: space-between;
        margin-block-start: 60px;

        @media (max-width: 600px) {
            align-items: center;
            flex-direction: column;
        }
    }
</style>
